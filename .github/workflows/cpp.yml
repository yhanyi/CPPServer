name: C++ CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    runs-on: macos-latest
    timeout-minutes: 10
    
    steps:
    - uses: actions/checkout@v2

    - name: Install dependencies
      run: |
        brew install nlohmann-json
        brew install googletest
        brew install curl
        brew install prometheus
        brew install prometheus-cpp
        brew install postgresql@14
        brew install libpqxx
        brew link postgresql@14 --force

    - name: Start PostgreSQL
      run: |
        brew services start postgresql@14
        sleep 3  # Wait for PostgreSQL to start

    - name: Setup PostgreSQL
      run: |
        brew services start postgresql@14
    
        # Wait for PostgreSQL to be ready with proper timeout
        attempt=0
        until pg_isready || [ $attempt -eq 30 ]; do
          attempt=$((attempt + 1))
          echo "Waiting for PostgreSQL (attempt: $attempt)..."
          sleep 1
        done
    
        if ! pg_isready; then
          echo "PostgreSQL failed to start"
          exit 1
        fi
    
        # Create test user with proper permissions
        createuser -s $USER

    - name: Start Prometheus
      run: |
        prometheus --config.file=./prometheus.yml &
        sleep 5

    - name: Build
      run: |
        make clean
        make all

    - name: Run Tests
      timeout-minutes: 15
      run: |
        # Run tests in parallel with proper timeout
        make test -j4

    - name: Run Server Tests
      timeout-minutes: 5  # Add timeout for server tests
      run: |
        # Run tests with timeout
        timeout 300 ./server_tests || {
          echo "Server tests timed out or failed"
          # Cleanup any hanging processes
          pkill -f server_tests || true
          exit 1
        }

    - name: Run Database Tests
      timeout-minutes: 5
      run: |
        ./database_tests

    - name: Run Cache Tests
      timeout-minutes: 5
      run: |
        ./cache_tests

    - name: Run Integration Tests
      timeout-minutes: 5
      run: |
        # Start server in background
        ./server &
        SERVER_PID=$!
        
        # Wait for server to start
        max_attempts=30
        attempt=0
        while ! curl -s http://localhost:8080/api/hello > /dev/null; do
          if [ $attempt -ge $max_attempts ]; then
            echo "Server failed to start"
            kill $SERVER_PID || true
            exit 1
          fi
          sleep 1
          ((attempt++))
        done
        
        # Run tests
        curl -X POST http://localhost:8080/api/cached \
          -H "Content-Type: application/json" \
          -d '{"key":"test","value":"value","ttl":300}'
        
        curl http://localhost:8080/api/cached/test
        
        curl -O -J "http://localhost:8080/api/export"
        
        # Cleanup
        kill $SERVER_PID || true

    - name: Stop Services
      if: always()
      run: |
        brew services stop postgresql@14
        pkill prometheus || true
        pkill -f server || true
        pkill -f server_tests || true
